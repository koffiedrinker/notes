# Format strings

## Basic stuff

* [PicoCTF format string explanation](https://vimeo.com/65014452)
* Width precision argument: `%346c`
* Select argument: `%2$x`
* Write number of printed bytes to an address: `%n`, `%hn`, `%hhn`

To print the stack nicely: `%08x %08x %08x %08x %08x %08x %08x %08x\n`

### Arbitrary read with format string vulnerabilities

If the first four bytes of our format string our at position 6, we can use `%s` to interpret those four bytes as a reference to a string/bytes somewhere in memory rather than just interpret it as a value (like `%d` would do):
```
AAAA%6$s
```

print the bytes at 0x41414141 as a string.

See example 00 and 04 for examples of reading arbitrary data from a binary using a format string.

### Arbitrary write with format string vulnerabilities

Generally you will put the location of your write inside the format string and then use the format string vulnerability to find your own format string on the stack. Once you have located your format string and thus the address of your write, you can use `%n` to write to that address. Probably you'll overwrite a .got.plt entry or some other function pointer that is referenced later on in the execution.
```
AAAA%346c%6$hn
```

Will write 350 as a short integer at 0x41414141.

## Cool stuff

### Forging an address when the format string itself is not on the stack

TODO

Source: [Gynvael livestream #15: Advanced format strings](https://www.youtube.com/watch?v=xAdjDEwENCQ)

### 

## Protecting against format strings vulnerabilities

* Use `FORTIFY_SOURCE` compile flag with gcc to disable usage of `%n`


## Small print

* Windows disables `%n` by default, see security note at the bottom of [this article](https://msdn.microsoft.com/en-us/library/hf4y5e3w.aspx) (last box).
* If the second write needs less bytes written, swap the writes or alternatively just make it positive by adding 65336 (let's say difference between them is -5000, just do -5000 + 2^16)


## Extra resources

See resources folder but original hyperlinks here:
* [Syracus Uni - format strings](http://www.cis.syr.edu/~wedu/Teaching/cis643/LectureNotes_New/Format_String.pdf)
* [TESO Format String vulnerabilities (2001)](https://crypto.stanford.edu/cs155old/cs155-spring08/papers/formatstring-1.2.pdf)
* [Format String Exploitation Tutorial (exploit-db)](https://www.exploit-db.com/docs/28476.pdf)
